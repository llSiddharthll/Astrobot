<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Markdown renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Simple animation library -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <title>Astro AI Chat</title>

    <style>
        .chat-panel-hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateX(120%) scale(0.96);
        }

        .chat-panel-visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0) scale(1);
        }

        /* custom scrollbar for chat */
        #chatMessages::-webkit-scrollbar {
            width: 6px;
        }

        #chatMessages::-webkit-scrollbar-thumb {
            background: #fbbf24;
            border-radius: 999px;
        }
        
        /* Message animations */
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-animation {
            animation: messageSlideIn 0.3s ease-out forwards;
        }
        
        /* Floating button pulse animation */
        @keyframes gentlePulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
            }
            50% {
                box-shadow: 0 0 0 12px rgba(245, 158, 11, 0);
            }
        }
        
        .pulse-ring {
            animation: gentlePulse 2s infinite;
        }
        
        /* Glow effect for header */
        .header-glow {
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3);
        }
        
        /* Typing indicator */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #f59e0b;
            animation: typingPulse 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingPulse {
            0%, 60%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            30% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Button styles */
        .action-btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .action-btn:active {
            transform: translateY(0);
        }
    </style>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/scrollreveal@4.0.9/dist/scrollreveal.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Lato:wght@300;400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --golden-harmony: #D4AF37;
            --deep-balance: #000000;
            --pure-light: #FFFFFF;
            --calm-stone: #EAEAEA;
        }

        body {
            font-family: 'Lato', sans-serif;
            background-color: #f9f9f9;
            color: #333;
        }

        .brand-font {
            font-family: 'Cinzel', serif;
        }

        .golden-gradient {
            background: linear-gradient(135deg, #D4AF37 0%, #B8941F 100%);
        }

        .golden-text {
            color: #D4AF37;
        }

        .golden-border {
            border-color: #D4AF37;
        }

        .chart-container {
            background-color: var(--pure-light);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.5s ease;
        }

        .input-field {
            border: 2px solid var(--calm-stone);
            transition: all 0.3s ease;
        }

        .input-field:focus {
            border-color: var(--golden-harmony);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .btn-primary {
            background-color: var(--deep-balance);
            color: var(--pure-light);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary:hover {
            background-color: #1a1a1a;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.7s ease;
        }

        .btn-primary:hover:after {
            left: 100%;
        }

        .loading {
            display: none;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            border: 3px solid rgba(212, 175, 55, 0.3);
            border-top: 3px solid var(--golden-harmony);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .fade-in {
            animation: fadeIn 0.8s ease forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(212, 175, 55, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(212, 175, 55, 0);
            }
        }

        .chart-svg-container svg {
            width: 100%;
            height: auto;
            max-width: 600px;
        }

        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }
        
        .dosha-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .dosha-yes {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .dosha-no {
            background-color: #dcfce7;
            color: #16a34a;
        }
        
        .planet-house {
            display: inline-block;
            width: 24px;
            height: 24px;
            background: var(--golden-harmony);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-size: 0.75rem;
            margin-right: 4px;
        }
        
        .symbol-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }
        
        .symbol-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f8f8f8;
            border-radius: 8px;
            border-left: 4px solid var(--golden-harmony);
        }
        
        .symbol-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
            color: white;
        }
        
        /* Planet Colors */
        .planet-sun { background: linear-gradient(135deg, #FFD700, #FF8C00); }
        .planet-moon { background: linear-gradient(135deg, #C0C0C0, #A9A9A9); }
        .planet-mars { background: linear-gradient(135deg, #FF4500, #8B0000); }
        .planet-mercury { background: linear-gradient(135deg, #32CD32, #228B22); }
        .planet-jupiter { background: linear-gradient(135deg, #FFD700, #DAA520); }
        .planet-venus { background: linear-gradient(135deg, #FF69B4, #C71585); }
        .planet-saturn { background: linear-gradient(135deg, #A0522D, #8B4513); }
        .planet-rahu { background: linear-gradient(135deg, #4B0082, #2E0854); }
        .planet-ketu { background: linear-gradient(135deg, #800080, #4B0082); }
        
        /* House Colors */
        .house-1 { border-left-color: #D4AF37; }
        .house-2 { border-left-color: #2E8B57; }
        .house-3 { border-left-color: #4682B4; }
        .house-4 { border-left-color: #8A2BE2; }
        .house-5 { border-left-color: #DC143C; }
        .house-6 { border-left-color: #FF8C00; }
        .house-7 { border-left-color: #20B2AA; }
        .house-8 { border-left-color: #778899; }
        .house-9 { border-left-color: #D2691E; }
        .house-10 { border-left-color: #6495ED; }
        .house-11 { border-left-color: #FF1493; }
        .house-12 { border-left-color: #7CFC00; }
    </style>
</head>

<body class="bg-gray-100">


    <!-- FLOATING BUTTON -->
    <div class="fixed bottom-6 right-6 z-40">
        <div class="relative">
            <div class="absolute inset-0 rounded-full pulse-ring"></div>
            <button id="chatIcon"
                class="relative w-16 h-16 bg-gradient-to-br from-yellow-400 via-amber-500 to-yellow-700
                       text-white rounded-full shadow-2xl text-3xl flex items-center justify-center
                       ring-2 ring-yellow-200 hover:ring-yellow-400
                       hover:scale-110 transition-all duration-300 cursor-pointer">
                ðŸ”®
            </button>
        </div>
    </div>

    <!-- CHAT PANEL -->
    <div id="chatPanel"
        class="fixed bottom-24 right-4 w-[340px] sm:w-[380px] h-[80vh] bg-gradient-to-b from-amber-50 to-yellow-50
               shadow-[0_20px_50px_rgba(0,0,0,0.25)] border border-amber-100
               rounded-3xl chat-panel-hidden transition-all duration-300 ease-out flex flex-col overflow-hidden z-30">

        <!-- Header -->
        <div
            class="p-4 bg-gradient-to-r from-yellow-500 via-amber-500 to-yellow-600 text-white flex justify-between items-center header-glow">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-lg">
                    âœ¨
                </div>
                <div>
                    <h2 class="text-lg font-semibold tracking-wide">Astro AI Assistant</h2>
                    <p class="text-xs text-amber-100">Your cosmic buddy, not a boring bot</p>
                </div>
            </div>
            <button id="closeChat"
                class="w-8 h-8 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 text-lg font-bold transition-all duration-200">
                âœ•
            </button>
        </div>

        <!-- Chat messages -->
        <div id="chatMessages"
            class="flex-1 p-4 overflow-y-auto space-y-4 bg-gradient-to-b from-amber-50/80 to-amber-100/40 relative overflow-x-hidden">

            <!-- subtle bg elements -->
            <div
                class="pointer-events-none absolute -bottom-20 -right-10 w-40 h-40 bg-yellow-200/40 rounded-full blur-3xl">
            </div>
            <div
                class="pointer-events-none absolute -top-20 -left-10 w-32 h-32 bg-amber-300/30 rounded-full blur-3xl">
            </div>
        </div>

        <!-- Input -->
        <div class="p-4 border-t border-amber-100 bg-white/80 backdrop-blur-sm">
            <div class="text-[11px] text-gray-500 mb-1 flex justify-between">
                <span>Press <span class="font-semibold text-amber-600">Enter</span> to send</span>
                <span class="hidden sm:inline"><span class="font-semibold text-amber-600">Shift + Enter</span> for new line</span>
            </div>
            <div class="relative">
                <textarea id="chatInput" rows="2"
                    class="w-full border border-amber-200 rounded-2xl px-4 py-3 shadow-sm text-sm
                           focus:ring-2 focus:ring-amber-400 focus:border-amber-400 resize-none pr-12 outline-none"
                    placeholder="Type your cosmic vibes here..."></textarea>
                <button id="sendBtn"
                    class="absolute right-2 bottom-2 w-8 h-8 bg-gradient-to-r from-yellow-500 to-amber-500 
                           text-white rounded-full flex items-center justify-center text-sm
                           hover:shadow-md hover:scale-105 active:scale-95 transition-all duration-200">
                    â†‘
                </button>
            </div>
        </div>
    </div>

        <!-- Main Content -->
    <main class="container mx-auto px-4 md:px-8 py-8">
        <div class="text-center mb-12">
            <h2 class="brand-font text-4xl md:text-5xl font-bold mb-4 fade-in">Kundli Chart Generator</h2>
            <p class="text-lg text-gray-700 max-w-3xl mx-auto">Discover your celestial blueprint. Enter your birth
                details to generate a personalized Vedic astrology chart based on ancient wisdom and modern precision.
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Input Form -->
            <div class="chart-container p-6 md:p-8 fade-in">
                <h3 class="brand-font text-2xl font-bold mb-6 pb-4 border-b border-gray-200">Enter Birth Details</h3>

                <form id="kundliForm" class="space-y-6">
                    <div>
                        <label class="block text-gray-700 mb-2 font-medium">Full Name</label>
                        <input type="text" id="userName" placeholder="Enter your full name"
                            class="w-full p-4 input-field rounded-lg focus:outline-none" required>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 mb-2 font-medium">Date of Birth</label>
                            <input type="date" id="dob" class="w-full p-4 input-field rounded-lg focus:outline-none"
                                required>
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-2 font-medium">Time of Birth</label>
                            <input type="time" id="tob" class="w-full p-4 input-field rounded-lg focus:outline-none"
                                required>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 mb-2 font-medium">Place of Birth</label>
                            <input type="text" id="place" placeholder="City, Country"
                                class="w-full p-4 input-field rounded-lg focus:outline-none" required>
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-2 font-medium">Get Coordinates</label>
                            <button type="button" id="getCoordsBtn"
                                class="w-full p-4 bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition-colors focus:outline-none">
                                <i class="fas fa-map-marker-alt mr-2"></i>Auto-Detect
                            </button>
                        </div>
                    </div>

                    <div class="hidden" id="coordsContainer">
                        <label class="block text-gray-700 mb-2 font-medium">Coordinates (Latitude, Longitude)</label>
                        <input type="text" id="coordinates" placeholder="e.g., 19.0760,72.8777"
                            class="w-full p-4 input-field rounded-lg focus:outline-none">
                    </div>

                    <div class="pt-4">
                        <button type="submit" id="generateBtn"
                            class="w-full p-4 btn-primary rounded-lg text-lg font-medium focus:outline-none pulse">
                            <i class="fas fa-star-and-crescent mr-2"></i>Generate Kundli Chart
                        </button>
                    </div>
                </form>

                <!-- Loading Indicator -->
                <div id="loading" class="loading mt-8 flex-col items-center justify-center">
                    <div class="spinner mb-4"></div>
                    <p class="text-lg text-gray-700">Generating your Kundli chart...</p>
                    <p class="text-sm text-gray-500 mt-2">This may take a few moments</p>
                </div>

                <!-- Instructions -->
                <div class="mt-10 p-6 bg-gray-50 rounded-lg">
                    <h4 class="brand-font text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-info-circle golden-text mr-2"></i> How it works
                    </h4>
                    <ul class="space-y-3 text-gray-700">
                        <li class="flex items-start">
                            <i class="fas fa-check text-green-500 mt-1 mr-3"></i>
                            <span>Enter your accurate birth details (date, time, and place)</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check text-green-500 mt-1 mr-3"></i>
                            <span>Click "Auto-Detect" to fetch coordinates or enter them manually</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check text-green-500 mt-1 mr-3"></i>
                            <span>Generate your personalized Kundli chart</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check text-green-500 mt-1 mr-3"></i>
                            <span>Explore the planetary positions and houses at your birth time</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Chart Display -->
            <div class="chart-container p-6 md:p-8 fade-in">
                <h3 class="brand-font text-2xl font-bold mb-6 pb-4 border-b border-gray-200">Your Kundli Chart</h3>

                <div id="chartPlaceholder" class="flex flex-col items-center justify-center py-12 px-4 text-center">
                    <div class="w-48 h-48 golden-gradient rounded-full flex items-center justify-center mb-8 floating">
                        <i class="fas fa-star-and-crescent text-white text-6xl"></i>
                    </div>
                    <h4 class="brand-font text-2xl font-bold mb-4">Your Chart Awaits</h4>
                    <p class="text-gray-600 max-w-md">Enter your birth details and generate a personalized Vedic
                        astrology chart to explore the cosmic influences at the time of your birth.</p>
                </div>

                <div id="chartResult" class="hidden">
                    <div class="mb-6">
                        <h4 id="chartTitle" class="brand-font text-xl font-bold mb-2"></h4>
                        <div id="chartDetails" class="text-gray-600"></div>
                    </div>

                    <div
                        class="chart-svg-container flex justify-center items-center p-4 border border-gray-200 rounded-lg bg-white">
                        <!-- SVG chart will be inserted here -->
                        <div id="chartSvgContainer"></div>
                    </div>
                    
                    <!-- Additional Chart Info -->
                    <div id="chartInfo" class="mt-6 space-y-6 hidden">
                        <div>
                            <h5 class="font-bold text-lg mb-2 golden-text">Planetary Positions</h5>
                            <div id="planetPositions" class="flex flex-wrap gap-2"></div>
                        </div>
                        
                        <div>
                            <h5 class="font-bold text-lg mb-2 golden-text">Dosha Analysis</h5>
                            <div id="doshaAnalysis" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                        </div>
                        
                        <!-- Symbol Reference Guide -->
                        <div id="symbolGuide" class="mt-6">
                            <h5 class="font-bold text-lg mb-2 golden-text">Symbol Reference Guide</h5>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h6 class="font-bold mb-3 text-gray-700">Planetary Symbols:</h6>
                                <div class="symbol-grid mb-4">
                                    <!-- Planets will be added dynamically -->
                                </div>
                                
                                <h6 class="font-bold mb-3 text-gray-700">House Meanings:</h6>
                                <div class="symbol-grid">
                                    <!-- Houses will be added dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold golden-text mb-1">12</div>
                            <div class="text-sm text-gray-600">Houses</div>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold golden-text mb-1">9</div>
                            <div class="text-sm text-gray-600">Planets</div>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold golden-text mb-1">27</div>
                            <div class="text-sm text-gray-600">Nakshatras</div>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold golden-text mb-1">360Â°</div>
                            <div class="text-sm text-gray-600">Zodiac</div>
                        </div>
                    </div>
                </div>

                <!-- Sample Chart (for demo) -->
                <div id="sampleChart" class="mt-10 p-6 bg-gradient-to-r from-gray-900 to-black rounded-lg text-white">
                    <h4 class="brand-font text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-eye mr-2"></i> Sample Chart Preview
                    </h4>
                    <p class="text-gray-300 mb-4">This is a sample of how your generated Kundli chart will appear.</p>
                    <div class="flex justify-center">
                        <div class="relative w-64 h-64">
                            <!-- Simplified chart visualization -->
                            <div class="absolute inset-0 border-2 golden-border rounded-full"></div>
                            <div class="absolute inset-8 border-2 border-gray-600 rounded-full"></div>
                            <div class="absolute top-1/2 left-0 right-0 h-0.5 bg-gray-600 transform -translate-y-1/2">
                            </div>
                            <div class="absolute top-0 bottom-0 left-1/2 w-0.5 bg-gray-600 transform -translate-x-1/2">
                            </div>

                            <!-- Planets -->
                            <div
                                class="absolute top-4 left-1/2 transform -translate-x-1/2 w-6 h-6 golden-gradient rounded-full flex items-center justify-center">
                                <i class="fas fa-sun text-xs text-white"></i>
                            </div>
                            <div
                                class="absolute bottom-4 left-1/2 transform -translate-x-1/2 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-moon text-xs text-white"></i>
                            </div>
                            <div
                                class="absolute top-1/2 left-4 transform -translate-y-1/2 w-6 h-6 bg-red-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-circle text-xs text-white"></i>
                            </div>
                            <div
                                class="absolute top-1/2 right-4 transform -translate-y-1/2 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-circle text-xs text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>


    <script>
        // Backend API URL
        const BACKEND_URL = 'https://astrobot-pgj9.onrender.com';
        
        // DOM elements
        const kundliForm = document.getElementById("kundliForm");
        const getCoordsBtn = document.getElementById("getCoordsBtn");
        const coordsContainer = document.getElementById("coordsContainer");
        const coordinatesInput = document.getElementById("coordinates");
        const loading = document.getElementById("loading");
        const generateBtn = document.getElementById("generateBtn");
        const chartPlaceholder = document.getElementById("chartPlaceholder");
        const chartResult = document.getElementById("chartResult");
        const chartSvgContainer = document.getElementById("chartSvgContainer");
        const chartTitle = document.getElementById("chartTitle");
        const chartDetails = document.getElementById("chartDetails");
        const chartInfo = document.getElementById("chartInfo");
        const planetPositionsDiv = document.getElementById("planetPositions");
        const doshaAnalysisDiv = document.getElementById("doshaAnalysis");
        const symbolGuide = document.getElementById("symbolGuide");

        // Planet information
        const planetInfo = {
            'Sun': { symbol: 'â˜‰', color: 'planet-sun', meaning: 'Soul, Self, Vitality' },
            'Moon': { symbol: 'â˜½', color: 'planet-moon', meaning: 'Mind, Emotions, Mother' },
            'Mars': { symbol: 'â™‚', color: 'planet-mars', meaning: 'Energy, Action, Courage' },
            'Mercury': { symbol: 'â˜¿', color: 'planet-mercury', meaning: 'Intellect, Communication' },
            'Jupiter': { symbol: 'â™ƒ', color: 'planet-jupiter', meaning: 'Wisdom, Growth, Luck' },
            'Venus': { symbol: 'â™€', color: 'planet-venus', meaning: 'Love, Beauty, Relationships' },
            'Saturn': { symbol: 'â™„', color: 'planet-saturn', meaning: 'Discipline, Karma, Time' },
            'Rahu': { symbol: 'â˜Š', color: 'planet-rahu', meaning: 'North Node, Desires' },
            'Ketu': { symbol: 'â˜‹', color: 'planet-ketu', meaning: 'South Node, Spirituality' }
        };

        // House information
        const houseInfo = {
            1: { name: 'First House', meaning: 'Self, Personality, Body', color: 'house-1' },
            2: { name: 'Second House', meaning: 'Wealth, Family, Speech', color: 'house-2' },
            3: { name: 'Third House', meaning: 'Siblings, Courage, Communication', color: 'house-3' },
            4: { name: 'Fourth House', meaning: 'Home, Mother, Happiness', color: 'house-4' },
            5: { name: 'Fifth House', meaning: 'Children, Creativity, Education', color: 'house-5' },
            6: { name: 'Sixth House', meaning: 'Health, Enemies, Service', color: 'house-6' },
            7: { name: 'Seventh House', meaning: 'Marriage, Partnership', color: 'house-7' },
            8: { name: 'Eighth House', meaning: 'Longevity, Transformation', color: 'house-8' },
            9: { name: 'Ninth House', meaning: 'Luck, Father, Dharma', color: 'house-9' },
            10: { name: 'Tenth House', meaning: 'Career, Fame, Status', color: 'house-10' },
            11: { name: 'Eleventh House', meaning: 'Gains, Friends, Desires', color: 'house-11' },
            12: { name: 'Twelfth House', meaning: 'Loss, Liberation, Foreign', color: 'house-12' }
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize ScrollReveal
            ScrollReveal().reveal('.fade-in', {
                duration: 1000,
                distance: '30px',
                easing: 'ease-out',
                interval: 200
            });
            
            // Set default date to 25 years ago
            const defaultDate = new Date();
            defaultDate.setFullYear(defaultDate.getFullYear() - 25);
            document.getElementById('dob').valueAsDate = defaultDate;
            
            // Set default time to noon
            document.getElementById('tob').value = '12:00';
            
            // Display symbol guide initially
            displaySymbolGuide();
        });

        // Get coordinates from backend
        getCoordsBtn.addEventListener('click', async function () {
            const place = document.getElementById('place').value.trim();

            if (!place) {
                alert('Please enter a place name first.');
                return;
            }

            coordsContainer.classList.remove('hidden');

            const originalHTML = getCoordsBtn.innerHTML;
            getCoordsBtn.disabled = true;
            getCoordsBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Detecting...';

            try {
                // Call backend geocoding endpoint
                const response = await fetch(`${BACKEND_URL}/geocode?place=${encodeURIComponent(place)}`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "Failed to get coordinates");
                }

                const data = await response.json();

                coordinatesInput.value = data.coordinates;

                // Success UI feedback
                getCoordsBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Coordinates Found!';
                getCoordsBtn.classList.remove("bg-gray-800");
                getCoordsBtn.classList.add("bg-green-600");

                setTimeout(() => {
                    getCoordsBtn.disabled = false;
                    getCoordsBtn.classList.remove("bg-green-600");
                    getCoordsBtn.classList.add("bg-gray-800");
                    getCoordsBtn.innerHTML = originalHTML;
                }, 1500);

            } catch (err) {
                console.error("Coordinate Error:", err);

                coordinatesInput.value = "";
                coordinatesInput.placeholder = "Could not detect automatically. Enter manually.";

                getCoordsBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error';
                getCoordsBtn.classList.remove("bg-gray-800");
                getCoordsBtn.classList.add("bg-red-600");

                setTimeout(() => {
                    getCoordsBtn.disabled = false;
                    getCoordsBtn.classList.remove("bg-red-600");
                    getCoordsBtn.classList.add("bg-gray-800");
                    getCoordsBtn.innerHTML = originalHTML;
                }, 1500);
            }
        });

        // Generate Kundli chart via backend
        async function generateKundliChart(datetime, coordinates, userName) {
            try {
                const response = await fetch(`${BACKEND_URL}/generate-kundli`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        datetime: datetime,
                        coordinates: coordinates,
                        chart_type: "lagna",
                        chart_style: "north-indian"
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "Failed to generate chart");
                }

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || "Chart generation failed");
                }

                return data;

            } catch (err) {
                console.error("Kundli Generation Error:", err);
                throw err;
            }
        }

        // Display symbol guide
        function displaySymbolGuide() {
            // Display planet symbols
            const planetGrid = symbolGuide.querySelector('.symbol-grid:first-child');
            planetGrid.innerHTML = '';
            
            Object.entries(planetInfo).forEach(([planet, info]) => {
                const item = document.createElement('div');
                item.className = 'symbol-item';
                item.innerHTML = `
                    <div class="symbol-icon ${info.color}">${info.symbol}</div>
                    <div>
                        <div class="font-bold text-sm">${planet}</div>
                        <div class="text-xs text-gray-600">${info.meaning}</div>
                    </div>
                `;
                planetGrid.appendChild(item);
            });
            
            // Display house meanings
            const houseGrid = symbolGuide.querySelector('.symbol-grid:last-child');
            houseGrid.innerHTML = '';
            
            Object.entries(houseInfo).forEach(([houseNum, info]) => {
                const item = document.createElement('div');
                item.className = `symbol-item ${info.color}`;
                item.innerHTML = `
                    <div class="w-8 h-8 flex items-center justify-center mr-3 font-bold">${houseNum}</div>
                    <div>
                        <div class="font-bold text-sm">${info.name}</div>
                        <div class="text-xs text-gray-600">${info.meaning}</div>
                    </div>
                `;
                houseGrid.appendChild(item);
            });
        }

        // Create fallback chart with dosha information
        function createFallbackChart(planetData, doshaData, userName, place, dob) {
            // Create a simplified SVG chart with colors
            const svg = `
                <div class="flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="380" height="380" viewBox="0 0 400 400">
                        <rect x="0" y="0" width="400" height="400" fill="#fff7e9" />
                        
                        <!-- Outer golden circle -->
                        <circle cx="200" cy="200" r="180" fill="none" stroke="#D4AF37" stroke-width="4"/>
                        
                        <!-- Colored house divisions -->
                        ${Array.from({length: 12}, (_, i) => {
                            const angle = i * 30;
                            const rad = angle * Math.PI / 180;
                            const x1 = 200 + 180 * Math.sin(rad);
                            const y1 = 200 - 180 * Math.cos(rad);
                            const x2 = 200 + 100 * Math.sin(rad);
                            const y2 = 200 - 100 * Math.cos(rad);
                            const colors = ['#D4AF37', '#2E8B57', '#4682B4', '#8A2BE2', '#DC143C', '#FF8C00', 
                                          '#20B2AA', '#778899', '#D2691E', '#6495ED', '#FF1493', '#7CFC00'];
                            return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${colors[i]}" stroke-width="2" opacity="0.8"/>`;
                        }).join('')}
                        
                        <!-- Middle and inner circles -->
                        <circle cx="200" cy="200" r="140" fill="none" stroke="#b8941f" stroke-width="2"/>
                        <circle cx="200" cy="200" r="100" fill="none" stroke="#5b3b16" stroke-width="1"/>
                        
                        <!-- House numbers -->
                        ${Array.from({length: 12}, (_, i) => {
                            const angle = i * 30 + 15;
                            const rad = angle * Math.PI / 180;
                            const x = 200 + 130 * Math.sin(rad);
                            const y = 200 - 130 * Math.cos(rad);
                            return `<text x="${x}" y="${y}" text-anchor="middle" fill="#5b3b16" font-size="14" font-weight="bold">${i+1}</text>`;
                        }).join('')}
                        
                        <!-- Planet positions -->
                        ${Object.entries(planetData).map(([planet, house], index) => {
                            const angle = (house - 1) * 30 + 15;
                            const rad = angle * Math.PI / 180;
                            const x = 200 + 70 * Math.sin(rad);
                            const y = 200 - 70 * Math.cos(rad);
                            const planetSymbol = planetInfo[planet]?.symbol || planet.charAt(0);
                            const planetColor = planetInfo[planet]?.color || 'planet-sun';
                            
                            // Generate gradient based on planet
                            const gradientId = `grad-${planet.toLowerCase()}`;
                            let gradientFill = '#D4AF37';
                            
                            if (planet === 'Sun') gradientFill = 'url(#sun-gradient)';
                            else if (planet === 'Moon') gradientFill = 'url(#moon-gradient)';
                            else if (planet === 'Mars') gradientFill = 'url(#mars-gradient)';
                            else if (planet === 'Mercury') gradientFill = 'url(#mercury-gradient)';
                            else if (planet === 'Jupiter') gradientFill = 'url(#jupiter-gradient)';
                            else if (planet === 'Venus') gradientFill = 'url(#venus-gradient)';
                            else if (planet === 'Saturn') gradientFill = 'url(#saturn-gradient)';
                            else if (planet === 'Rahu') gradientFill = 'url(#rahu-gradient)';
                            else if (planet === 'Ketu') gradientFill = 'url(#ketu-gradient)';
                            
                            return `
                                <circle cx="${x}" cy="${y}" r="16" fill="${gradientFill}"></circle>
                                <text x="${x}" y="${y+5}" text-anchor="middle" fill="white" font-size="12" font-weight="bold">${planetSymbol}</text>
                            `;
                        }).join('')}
                        
                        <!-- Chart title -->
                        <text x="200" y="30" text-anchor="middle" fill="#5b3b16" font-size="16" font-weight="bold">${userName}'s Kundli</text>
                        
                        <!-- Define gradients for planets -->
                        <defs>
                            <linearGradient id="sun-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#FF8C00;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="moon-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#C0C0C0;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#A9A9A9;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="mars-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#FF4500;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#8B0000;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="mercury-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#32CD32;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#228B22;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="jupiter-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#DAA520;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="venus-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#FF69B4;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#C71585;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="saturn-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#A0522D;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#8B4513;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="rahu-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#4B0082;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#2E0854;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="ketu-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#800080;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#4B0082;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
            `;
            
            return {
                svg: svg,
                planets: planetData,
                mangalDosha: doshaData.mangalDosha || {},
                kaalSarpDosha: doshaData.kaalSarpDosha || {},
                pitraDosha: doshaData.pitraDosha || {},
                sadeSati: doshaData.sadeSati || {}
            };
        }

        // Display planetary positions
        function displayPlanetPositions(planets) {
            if (!planets || Object.keys(planets).length === 0) {
                planetPositionsDiv.innerHTML = '<p class="text-gray-500">No planetary data available</p>';
                return;
            }
            
            let html = '';
            Object.entries(planets).forEach(([planet, house]) => {
                const info = planetInfo[planet] || { symbol: planet.charAt(0), color: 'planet-sun', meaning: '' };
                const houseInfoText = houseInfo[house] ? `House ${house}: ${houseInfo[house].meaning}` : `House ${house}`;
                
                html += `
                    <div class="flex items-center bg-gray-50 px-3 py-2 rounded-lg border-l-4 ${info.color}">
                        <span class="symbol-icon ${info.color} mr-3">${info.symbol}</span>
                        <div>
                            <div class="font-bold text-gray-700">${planet}</div>
                            <div class="text-sm text-gray-600">${houseInfoText}</div>
                        </div>
                    </div>
                `;
            });
            
            planetPositionsDiv.innerHTML = html;
        }

        // Display dosha analysis
        function displayDoshaAnalysis(mangalDosha, kaalSarpDosha, pitraDosha, sadeSati) {
            const doshas = [
                {
                    name: 'Mangal Dosha',
                    value: mangalDosha?.has_dosha ? 'Yes' : 'No',
                    description: mangalDosha?.has_dosha ? 'May affect marriage' : 'No issues',
                    icon: 'fa-fire'
                },
                {
                    name: 'Kaal Sarp Dosha',
                    value: kaalSarpDosha?.has_dosha ? 'Yes' : 'No',
                    description: kaalSarpDosha?.has_dosha ? 'Planets between Rahu-Ketu' : 'No dosha',
                    icon: 'fa-snake'
                },
                {
                    name: 'Pitra Dosha',
                    value: pitraDosha?.has_dosha ? 'Yes' : 'No',
                    description: pitraDosha?.has_dosha ? 'Ancestral issues' : 'No issues',
                    icon: 'fa-ghost'
                },
                {
                    name: 'Sade Sati',
                    value: sadeSati?.is_sade_sati ? 'Active' : 'Inactive',
                    description: sadeSati?.is_sade_sati ? 'Saturn transit ongoing' : 'Not active',
                    icon: 'fa-saturn'
                }
            ];
            
            let html = '';
            doshas.forEach(dosha => {
                const hasDosha = dosha.value === 'Yes' || dosha.value === 'Active';
                html += `
                    <div class="bg-gray-50 p-4 rounded-lg border-l-4 ${hasDosha ? 'border-red-500' : 'border-green-500'}">
                        <div class="flex items-center mb-2">
                            <i class="fas ${dosha.icon} mr-2 ${hasDosha ? 'text-red-500' : 'text-green-500'}"></i>
                            <div class="font-bold">${dosha.name}</div>
                        </div>
                        <span class="dosha-badge ${hasDosha ? 'dosha-yes' : 'dosha-no'}">${dosha.value}</span>
                        <p class="text-sm text-gray-600 mt-2">${dosha.description}</p>
                    </div>
                `;
            });
            
            doshaAnalysisDiv.innerHTML = html;
        }

        // Enhance SVG with colors if needed
        function enhanceSvgColors(svgText) {
            // This function could enhance the SVG colors if they're monochrome
            // For now, we just return the original SVG
            return svgText;
        }

        // Form submit handler
        kundliForm.addEventListener("submit", async e => {
            e.preventDefault();

            const name = document.getElementById("userName").value.trim();
            const dob = document.getElementById("dob").value;
            const tob = document.getElementById("tob").value;
            const place = document.getElementById("place").value.trim();
            const coordinates = coordinatesInput.value.trim();

            // Validation
            if (!name || !dob || !tob || !place) {
                alert('Please fill in all required fields.');
                return;
            }

            if (!coordinates) {
                alert('Please get coordinates or enter them manually.');
                coordsContainer.classList.remove('hidden');
                return;
            }

            const datetime = `${dob}T${tob}:00+05:30`;

            // Show loading
            loading.classList.add("active");
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';

            try {
                // Generate chart via backend
                const chartData = await generateKundliChart(datetime, coordinates, name);
                
                // Hide placeholder and show result
                chartPlaceholder.classList.add("hidden");
                chartResult.classList.remove("hidden");
                chartInfo.classList.remove("hidden");

                // Set chart details
                chartTitle.innerText = `${name}'s Kundli Chart`;
                
                const birthDate = new Date(dob);
                const formattedDate = birthDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                chartDetails.innerHTML = `<p>Born on ${formattedDate} at ${tob} in ${place}</p>`;

                // Add sandbox mode note if applicable
                if (chartData.isSandboxMode) {
                    const sandboxNote = document.createElement('p');
                    sandboxNote.className = 'text-amber-600 text-sm mt-2 italic';
                    sandboxNote.innerHTML = '<i class="fas fa-info-circle mr-2"></i>Note: Using sandbox mode (January 1st date) for demonstration purposes';
                    chartDetails.appendChild(sandboxNote);
                }

                // Display chart SVG
                if (chartData.svg) {
                    // Enhance SVG colors if needed
                    const enhancedSvg = enhanceSvgColors(chartData.svg);
                    chartSvgContainer.innerHTML = enhancedSvg;
                } else {
                    // Fallback if no SVG returned
                    const fallbackData = createFallbackChart(
                        chartData.planets || {}, 
                        {
                            mangalDosha: chartData.mangalDosha,
                            kaalSarpDosha: chartData.kaalSarpDosha,
                            pitraDosha: chartData.pitraDosha,
                            sadeSati: chartData.sadeSati
                        },
                        name, place, dob
                    );
                    chartSvgContainer.innerHTML = fallbackData.svg;
                }

                // Display additional information
                displayPlanetPositions(chartData.planets || {});
                displayDoshaAnalysis(
                    chartData.mangalDosha,
                    chartData.kaalSarpDosha,
                    chartData.pitraDosha,
                    chartData.sadeSati
                );

                // Animate the chart appearance
                const svgElement = chartSvgContainer.querySelector('svg');
                if (svgElement) {
                    svgElement.style.opacity = '0';
                    svgElement.style.transform = 'scale(0.9)';
                    
                    setTimeout(() => {
                        svgElement.style.transition = 'opacity 0.8s ease, transform 0.8s ease';
                        svgElement.style.opacity = '1';
                        svgElement.style.transform = 'scale(1)';
                    }, 100);
                }

            } catch (err) {
                console.error("Chart generation error:", err);
                alert(`Error generating chart: ${err.message}`);
                
                // Show fallback chart
                chartPlaceholder.classList.add("hidden");
                chartResult.classList.remove("hidden");
                chartInfo.classList.remove("hidden");
                
                chartTitle.innerText = `${name}'s Kundli Chart`;
                chartDetails.innerHTML = `<p>Born on ${dob} in ${place} (Fallback Visualization)</p>`;
                
                const fallbackData = createFallbackChart(
                    {}, 
                    {
                        mangalDosha: { has_dosha: false },
                        kaalSarpDosha: { has_dosha: false },
                        pitraDosha: { has_dosha: false },
                        sadeSati: { is_sade_sati: false }
                    },
                    name, place, dob
                );
                
                chartSvgContainer.innerHTML = fallbackData.svg;
                displayPlanetPositions({});
                displayDoshaAnalysis(
                    { has_dosha: false },
                    { has_dosha: false },
                    { has_dosha: false },
                    { is_sade_sati: false }
                );
            } finally {
                // Hide loading
                loading.classList.remove("active");
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-star-and-crescent mr-2"></i>Generate Kundli Chart';
            }
        });
    </script>

    <script>
        /* ===========================================
           PANEL SLIDE OPEN / CLOSE
        =========================================== */
        const panel = document.getElementById("chatPanel");
        const chatIcon = document.getElementById("chatIcon");
        const closeChat = document.getElementById("closeChat");
        const msgBox = document.getElementById("chatMessages");
        const input = document.getElementById("chatInput");
        const sendBtn = document.getElementById("sendBtn");

        let conversationStarted = false;
        let currentMode = null; // 'horoscope', 'chat'

        function openPanel() {
            panel.classList.remove("chat-panel-hidden");
            panel.classList.add("chat-panel-visible");

            if (!conversationStarted) {
                showInitialOptions();
                conversationStarted = true;
            }
            
            // Focus input after a short delay
            setTimeout(() => {
                input.focus();
            }, 400);
        }

        function closePanel() {
            panel.classList.add("chat-panel-hidden");
            panel.classList.remove("chat-panel-visible");
        }

        chatIcon.onclick = openPanel;
        closeChat.onclick = closePanel;

        /* ===========================================
           INITIAL OPTIONS
        =========================================== */
        function showInitialOptions() {
            addMessage("Hey there! ðŸ‘‹ I'm your cosmic buddy. What would you like to explore today?", "bot");
            
            setTimeout(() => {
                const optionsDiv = document.createElement("div");
                optionsDiv.className = "flex flex-col gap-3 mt-4";
                optionsDiv.innerHTML = `
                    <button class="action-btn bg-gradient-to-r from-yellow-500 to-amber-500 text-white py-3 px-4 rounded-2xl font-medium text-center" data-action="horoscope">
                        ðŸ”® Get Horoscope
                    </button>
                    <button class="action-btn bg-gradient-to-r from-gray-500 to-gray-700 text-white py-3 px-4 rounded-2xl font-medium text-center" data-action="chat">
                        ðŸ’¬ Chat About Anything Else
                    </button>
                `;
                
                const wrapper = document.createElement("div");
                wrapper.className = "flex justify-start message-animation";
                wrapper.appendChild(optionsDiv);
                msgBox.appendChild(wrapper);
                msgBox.scrollTop = msgBox.scrollHeight;
                
                // Add event listeners to buttons
                document.querySelectorAll('[data-action]').forEach(button => {
                    button.addEventListener('click', function() {
                        const action = this.getAttribute('data-action');
                        handleInitialOption(action);
                    });
                });
            }, 800);
        }

        function handleInitialOption(action) {
            currentMode = action;
            
            // Clear the options
            const optionsWrapper = msgBox.querySelector('[data-action]')?.closest('.flex.justify-start');
            if (optionsWrapper) {
                optionsWrapper.remove();
            }
            
            if (action === 'horoscope') {
                startHoroscopeFlow();
            } else if (action === 'chat') {
                startChatFlow();
            }
        }

        /* ===========================================
           HOROSCOPE FLOW
        =========================================== */
        function startHoroscopeFlow() {
            addMessage("Let's dive into your horoscope! First, I need to know a bit about you.", "bot");
            setTimeout(() => {
                startConversation();
            }, 800);
        }

        /* ===========================================
           CHAT FLOW
        =========================================== */
        function startChatFlow() {
            addMessage("Cool! I'm here to chat about anything - astrology, life, or just random thoughts. What's on your mind?", "bot");
            currentMode = 'chat';
        }

        /* ===========================================
           FOLLOW-UP OPTIONS
        =========================================== */
        function showFollowUpOptions() {
            const optionsDiv = document.createElement("div");
            optionsDiv.className = "flex flex-col gap-2 mt-4";
            optionsDiv.innerHTML = `
                <button class="action-btn bg-gradient-to-r from-yellow-500 to-amber-500 text-white py-2 px-4 rounded-2xl font-medium text-center text-sm" data-action="horoscope">
                    ðŸ”® Get Horoscope Reading
                </button>
                <button class="action-btn bg-gradient-to-r from-gray-500 to-gray-700 text-white py-2 px-4 rounded-2xl font-medium text-center text-sm" data-action="chat">
                    ðŸ’¬ Chat About Something Else
                </button>
            `;
            
            const wrapper = document.createElement("div");
            wrapper.className = "flex justify-start message-animation";
            wrapper.appendChild(optionsDiv);
            msgBox.appendChild(wrapper);
            msgBox.scrollTop = msgBox.scrollHeight;
            
            // Add event listeners to buttons
            document.querySelectorAll('[data-action]').forEach(button => {
                button.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    handleFollowUpOption(action);
                });
            });
        }

        function handleFollowUpOption(action) {
            // Clear the options
            const optionsWrapper = msgBox.querySelector('[data-action]')?.closest('.flex.justify-start');
            if (optionsWrapper) {
                optionsWrapper.remove();
            }
            
            if (action === 'horoscope') {
                startHoroscopeFlow();
            } else if (action === 'chat') {
                startChatFlow();
            }
        }

        /* ===========================================
           STATE: QUESTIONS FLOW
        =========================================== */
        const answerKeys = ["dob", "zodiac", "concern", "preference", "energy"];

        let userState = {
            currentStep: 0,
            completed: false,
            questions: [
                "Alright, let's tune into your vibe first âœ¨\n\nWhat's your **date of birth**?",
                "Nice. And which **zodiac sign** do you feel most connected to?",
                "Tell me honestly â€” what's messing with your head more these days: **love, career, health, or just stress**?",
                "Okay, energy style question: do you vibe more with **wearable energy** (rings/bracelets), or **home energy** (yantra/vastu/decor)?",
                "Last one â€” what kind of energy do you want more of in life? **Peace, confidence, clarity, protection, or something else**?"
            ],
            answers: {},
            recommendationText: ""
        };

        function startConversation() {
            addMessage(userState.questions[0], "bot");
        }

        /* ===========================================
           UI: ADD MESSAGE
        =========================================== */
        function addMessage(text, sender) {
            const wrapper = document.createElement("div");
            wrapper.className = sender === "user" ? "flex justify-end" : "flex justify-start";
            wrapper.classList.add("message-animation");

            const bubble = document.createElement("div");
            bubble.className =
                sender === "user"
                    ? "inline-block bg-gradient-to-r from-yellow-500 to-amber-500 text-white px-4 py-2 rounded-2xl shadow max-w-[80%] text-sm"
                    : "inline-block bg-white/90 border border-amber-100 px-4 py-3 rounded-2xl shadow-sm max-w-[80%] text-sm prose prose-sm break-words";

            if (sender === "bot") {
                bubble.innerHTML = marked.parse(text);
            } else {
                bubble.textContent = text;
            }

            wrapper.appendChild(bubble);
            msgBox.appendChild(wrapper);
            msgBox.scrollTop = msgBox.scrollHeight;
        }

        function addThinking() {
            const div = document.createElement("div");
            div.className = "flex justify-start message-animation";
            const inner = document.createElement("div");
            inner.className =
                "inline-flex items-center gap-2 bg-white/80 border border-amber-100 px-4 py-2 rounded-2xl text-xs text-gray-500 italic";
            inner.innerHTML = `
                <div class="typing-indicator">
                    <span>Astro AI is thinking</span>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            div.appendChild(inner);
            msgBox.appendChild(div);
            msgBox.scrollTop = msgBox.scrollHeight;
            return div;
        }

        /* ===========================================
           MISTRAL CONFIG
        =========================================== */

        const MISTRAL_API_KEY = "MUxu2ZaEribo6ipRXm8oObJ0isy4my3t"; // <-- replace with your key

        async function generateFinalSuggestion(answers) {
            try {
                const response = await fetch("https://api.mistral.ai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${MISTRAL_API_KEY}`,
                    },
                    body: JSON.stringify({
                        model: "mistral-small-latest",
                        messages: [
                            {
                                role: "system",
                                content: `
You are a cool, funny, friendly astrologer bestie.
You DO NOT ask questions.
You already have the user's answers.

Based on their vibe, suggest exactly ONE main product from this list:
Bracelet, Ring, Pendant, Necklace, Stones, Yantra, Rudraksha, Vastu Decor Items, VIP E-Pooja, Services.

Choose based on:
- date of birth + zodiac = overall element/theme
- concern = what they are struggling with
- preference (wearable vs home) = type of product
- energy = what they want more of

Tone:
- casual, human, like WhatsApp chat
- a little playful and encouraging
- no corporate or "as an AI" language
- 3-6 short sentences max

Format (markdown):
- Start with a short friendly sentence.
- Bold the recommended product name once.
- Briefly explain WHY it matches their vibe.
- Optionally add 1 short line suggesting they check that category on the site.
                                `
                            },
                            {
                                role: "user",
                                content: `Here are the user's answers: ${JSON.stringify(answers)}`
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    return `âš ï¸ Mistral error: ${response.status} ${response.statusText}. Try again in a bit.`;
                }

                const data = await response.json();
                if (!data.choices || !data.choices[0]) {
                    return "âš ï¸ The stars lagged for a sec. Try again.";
                }

                return data.choices[0].message.content;

            } catch (e) {
                return "âš ï¸ Network glitch while talking to the universe. Try again in a moment.";
            }
        }

        async function chatAfterRecommendation(userMessage, state) {
            try {
                const response = await fetch("https://api.mistral.ai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${MISTRAL_API_KEY}`,
                    },
                    body: JSON.stringify({
                        model: "mistral-small-latest",
                        messages: [
                            {
                                role: "system",
                                content: `
You are the same friendly astrology buddy as before.
You already recommended something earlier.

Now:
- Just chat casually.
- Answer doubts or follow-up questions.
- Don't keep pushing products unless the user asks directly.
- Never say "as an AI".
- Keep messages short and human, like a friend on chat.
                                `
                            },
                            {
                                role: "user",
                                content: `
User's basic info: ${JSON.stringify(state.answers)}
Previous recommendation text: ${state.recommendationText || "not captured"}

User just said: ${userMessage}
                                `
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    return `âš ï¸ Mistral error: ${response.status} ${response.statusText}.`;
                }

                const data = await response.json();
                if (!data.choices || !data.choices[0]) {
                    return "âš ï¸ Universe is quiet right now. Try again.";
                }

                return data.choices[0].message.content;

            } catch (e) {
                return "âš ï¸ Network glitch. Try again.";
            }
        }

        /* ===========================================
           SEND HANDLER (ENTER + BUTTON)
        =========================================== */

        async function handleSend() {
            const text = input.value.trim();
            if (!text) return;

            addMessage(text, "user");
            input.value = "";
            input.style.height = "auto";

            // If flow NOT completed â†’ we are in question mode
            if (currentMode === 'horoscope' && !userState.completed && userState.currentStep < userState.questions.length) {
                const step = userState.currentStep;
                const key = answerKeys[step] || `q${step + 1}`;
                userState.answers[key] = text;
                userState.currentStep++;

                if (userState.currentStep < userState.questions.length) {
                    // ask next question directly (no API)
                    setTimeout(() => {
                        addMessage(userState.questions[userState.currentStep], "bot");
                    }, 600);
                    return;
                }

                // All questions answered â†’ call Mistral once
                const thinkingDiv = addThinking();
                const reply = await generateFinalSuggestion(userState.answers);
                thinkingDiv.remove();

                userState.completed = true;
                userState.recommendationText = reply;
                addMessage(reply, "bot");
                
                // Show follow-up options
                setTimeout(() => {
                    showFollowUpOptions();
                }, 1000);
                return;
            }

            // After recommendation â†’ normal chat mode with AI
            const thinkingDiv = addThinking();
            const followup = await chatAfterRecommendation(text, userState);
            thinkingDiv.remove();
            addMessage(followup, "bot");
        }

        sendBtn.onclick = handleSend;

        // Enter to send, Shift+Enter for new line
        input.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });

        // Auto-resize textarea
        input.addEventListener("input", () => {
            input.style.height = "auto";
            input.style.height = Math.min(input.scrollHeight, 96) + "px";
        });
    </script>

</body>
    
</html>